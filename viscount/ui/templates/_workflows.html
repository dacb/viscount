<div class="container-fluid" style="padding-bottom: 40px; padding-left: 40px; padding-right: 40px;">
	<div class="row-fluid">
		<div class="table-wrapper">
			<table id="workflows" class="stripe row-border order-column" cellspacing="0" width="100%">
				<thead>
					<tr>
						<th id="workflowID">Workflow ID</th>
						<th id="workflowName">Name</th>
						<th id="workflowDescription">Description</th>
						<th id="workflowRevision">Rev.</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
	<div class="row-fluid">
		<div class="col-md-12" id=wworkflowEditorTitle" style="text-align:center">
			Workflow Editor
		</div>
	</div>
	<div class="row-fluid">
		<div class="col-md-10">
			<div id="workflowEditorCytoscape" style="border:1px solid #CCC"></div>
		</div>
		<div class="col-md-2">
			editor controls go here
		</div>
	</div>
</div>

<script type="text/javascript">
function formatWorkflow(d) {
	var ret = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
	if (d.revised_from) {
		ret += '<tr><td colspan="2">Revised from</td></tr>'+
		'<tr><td>ID</td><td>'+d.revised_from.id+'</td></tr>'+
		'<tr><td>Name</td><td>'+d.revised_from.name+'</td></tr>'+
		'<tr><td>Description</td><td>'+d.revised_from.description+'</td></tr>'+
		'<tr><td>Revision</td><td>'+d.revised_from.revision+'</td></tr>';
	}
	// add linkout buttons
	ret += '<tr><td colspan="2">'+
			'<a href="#" class="btn btn-warning" role="button" id="workflow'+d.id+'events"> <i class="glyphicon glyphicon-bell"></i> Events </a>'+
			'</td></tr>'+
	'</table>'+
	'<script type="text/javascript">$("#workflow'+d.id+'events").click(function(){'+
	'var table = $("#events").DataTable(); table.column("#eventsWorkflowID").search("'+d.id+'").draw();'+
	' $("#eventsTabBtn").trigger("click");});<\/script>';
	// place cytoscape canvas
	ret += '<div id="cy'+d.id+'" style="height:400px;width=90%;position:relative;border:1px solid #CCC;left:0;top:0;"></div>';
	ret += '<script type="text/javascript">'+
	'$.ajax( {'+
		'url : "api/workflows/'+d.id+'/cytoscape",'+
		'dataType : "json",'+
		'type : "GET",'+
	'} ).fail(function(data) {'+
			'processAPIErrorMessages(data);'+
		'})'+
		'.success(function(data, textStatus, xhr) {'+
	'var cy'+d.id+' = cytoscape({'+
		'style : xhr.responseJSON.style,'+
		'elements : xhr.responseJSON.elements,'+
		'container: document.getElementById("cy'+d.id+'"),'+
		'ready: function(){ console.log("cy'+d.id+' ready") },'+
		'layout : {'+
				'name : "cose",'+
			'}'+
	'});'+
	'$("a[href=\'#workflowsTab\']").on("shown.bs.tab", function (e) {'+
	'	cy'+d.id+'.resize();'+
	'	cy'+d.id+'.fit();'+
	'});'+
		'});'+
'<\/script>';

	return ret;
}

function setupWorkflowEditor() {
	var cy = cytoscape({ 
			layout : { name : 'cose' },
			container: document.getElementById("workflowEditorCytoscape")
		});
	return cy;
}
document.getElementById("workflowEditorCytoscape").cy = setupWorkflowEditor();

$("a[href='#workflowsTab']").on("shown.bs.tab", function (e) {
	var cy = document.getElementById("workflowEditorCytoscape").cy;
	cy.resize();
	cy.fit();
});

function loadWorkflowInEditor(workflow_id) {
	$.ajax( {
		url : "api/workflows/'+d.id+'/cytoscape",
		dataType : "json",
		type : "GET",
	} ).fail(function(data) { processAPIErrorMessages(data); })
		.success(function(data, textStatus, xhr) {
			var cy = document.getElementById("workflowEditorCytoscape").cy;
			cy.load({ style : xhr.responseJSON.style, elements : xhr.responseJSON.elements });
		});
}

function loadWorkflowTable() {
	var table;
	if ( $.fn.dataTable.isDataTable('#workflows') ) {
		table = $('#workflows').DataTable();
		table.ajax.reload();
	} else {
		table = $('#workflows').DataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": { url: "/api/workflows/datatables", type : "post" },
			"columns": [
				{ "data": "id" },
				{ "data": "name" },
				{ "data": "description" },
				{ "data": "revision" },
				{
					"class":		  'details-control',
					"orderable":	  false,
					"data":			null,
					"defaultContent": ''
				},
				// hidden fields to display on expand
				{ "data": "revised_from\\.id", "visible" : false },
				{ "data": "revised_from\\.name", "visible" : false },
				{ "data": "revised_from\\.description", "visible" : false },
				{ "data": "revised_from\\.revision", "visible" : false },
			],
			"order": [[1, 'asc']]
		} );
	}

	return table
}

$(document).ready(function() {

	var table = loadWorkflowTable();

	// Add event listener for opening and closing details
	$('#workflows tbody').on('click', 'td.details-control', function () {
		var tr = $(this).closest('tr');
		var row = table.row( tr );
 
		if ( row.child.isShown() ) {
			// This row is already open - close it
			row.child.hide();
			tr.removeClass('shown');
		}
		else {
			// Open this row
			row.child( formatWorkflow(row.data()) ).show();
			tr.addClass('shown');
		}
	} );

});
</script>
