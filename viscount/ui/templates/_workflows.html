<div class="container-fluid">
	<div class="row-fluid">
		<div class="table-wrapper">
			<table id="workflows" class="stripe row-border order-column" cellspacing="0" width="100%">
				<thead>
					<tr>
						<th id="workflowID">Workflow ID</th>
						<th id="workflowName">Name</th>
						<th id="workflowDescription">Description</th>
						<th id="workflowRevision">Rev.</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
</div>
<div class="container-fluid">
	<div class="row-fluid">
		<div class="col-md-12" id="workflowEditorTitle" style="text-align:center">
			Workflow Editor
		</div>
	</div>
	<div class="row-fluid">
		<div class="col-md-10">
			<div id="workflowEditorCytoscape" style="border:1px solid #CCC"></div>
		</div>
		<div class="col-md-2">
			editor controls go here
		</div>
	</div>
</div>
<div class="container-fluid">
	<div class="row-fluid">
		<div class="panel panel-primary">
			<div class="panel-heading"><h3 class="panel-title">Create a new user</h3></div>
			<div class="panel-body">
				<form class="form-horizontal" action="/api/users" method="post" id="createUser" name="createUser">
					<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
					<div class="form-group">
						<label for="email" class="control-label col-xs-2">Email</label>
						<div class="col-xs-4">
							<input type="email" class="form-control" name="email" placeholder="Email">
						</div>
					</div>
					<div class="form-group">
						<label for="username" class="control-label col-xs-2">Username</label>
						<div class="col-xs-2">
							<input type="text" class="form-control" name="username" placeholder="Username">
						</div>
					</div>
					<div class="form-group">
						<label for="roles" class="control-label col-xs-2">Roles</label>
						<div class="col-xs-6">
							{% for role in roles %}
								<label class="checkbox-inline">
									<input type="checkbox" name="roles" value="{{ role.id }}"> {{ role.name }}
								</label>
							{% endfor %}
						</div>
					</div>
					<div class="form-group">
						<div class="col-xs-offset-2 col-xs-10">
							<button type="submit" id="createUserSubmit" class="btn btn-primary">Create User</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
function formatWorkflow(d) {
	var ret = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
	if (d.revised_from) {
		ret += '<tr><td colspan="2">Revised from</td></tr>'+
		'<tr><td>ID</td><td>'+d.revised_from.id+'</td></tr>'+
		'<tr><td>Name</td><td>'+d.revised_from.name+'</td></tr>'+
		'<tr><td>Description</td><td>'+d.revised_from.description+'</td></tr>'+
		'<tr><td>Revision</td><td>'+d.revised_from.revision+'</td></tr>';
	}
	// add linkout buttons
	ret += '<tr><td colspan="2">'+
			'<a href="#" class="btn btn-warning" role="button" id="workflow'+d.id+'events"> <i class="glyphicon glyphicon-bell"></i> Events </a>'+
			'&nbsp;&nbsp;&nbsp;&nbsp;'+
			'<a href="#workflowEditorTitle" class="btn btn-success" role="button" id="workflow'+d.id+'LoadInEditor"> <i class="glyphicon glyphicon-bell"></i> Load in editor </a>'+
			'</td></tr>'+
	'</table>'+
	'<script type="text/javascript">'+
	'$("#workflow'+d.id+'events").click(function(){'+
	'var table = $("#events").DataTable(); table.column("#eventsWorkflowID").search("'+d.id+'").draw();'+
	' $("#eventsTabBtn").trigger("click");});'+
	'$("#workflow'+d.id+'LoadInEditor").click(function(){'+
		'loadWorkflowInEditor('+d.id+');'+
	'});'+
	'<\/script>';

	return ret;
}

function setupWorkflowEditor() {
	var cy = cytoscape({ 
			layout : { name : 'cose' },
			container: document.getElementById("workflowEditorCytoscape")
		});
	return cy;
}
document.getElementById("workflowEditorCytoscape").cy = setupWorkflowEditor();

$("a[href='#workflowsTab']").on("shown.bs.tab", function (e) {
	var cy = document.getElementById("workflowEditorCytoscape").cy;
	cy.resize();
	cy.fit();
});

function loadWorkflowInEditor(workflow_id) {
	$.ajax( {
		url : 'api/workflows/'+workflow_id+'/cytoscape',
		dataType : "json",
		type : "GET",
	} ).fail(function(data) { processAPIErrorMessages(data); })
		.success(function(data, textStatus, xhr) {
			var cy = document.getElementById("workflowEditorCytoscape").cy;
			cy.load(xhr.responseJSON.elements);
			cy.style(xhr.responseJSON.style);
		});
}

function loadWorkflowTable() {
	var table;
	if ( $.fn.dataTable.isDataTable('#workflows') ) {
		table = $('#workflows').DataTable();
		table.ajax.reload();
	} else {
		table = $('#workflows').DataTable( {
			"processing": true,
			"serverSide": true,
			"ajax": { url: "/api/workflows/datatables", type : "post" },
			"columns": [
				{ "data": "id" },
				{ "data": "name" },
				{ "data": "description" },
				{ "data": "revision" },
				{
					"class":		  'details-control',
					"orderable":	  false,
					"data":			null,
					"defaultContent": ''
				},
				// hidden fields to display on expand
				{ "data": "revised_from\\.id", "visible" : false },
				{ "data": "revised_from\\.name", "visible" : false },
				{ "data": "revised_from\\.description", "visible" : false },
				{ "data": "revised_from\\.revision", "visible" : false },
			],
			"order": [[1, 'asc']]
		} );
	}

	return table
}

$(document).ready(function() {

	var table = loadWorkflowTable();

	// Add event listener for opening and closing details
	$('#workflows tbody').on('click', 'td.details-control', function () {
		var tr = $(this).closest('tr');
		var row = table.row( tr );
 
		if ( row.child.isShown() ) {
			// This row is already open - close it
			row.child.hide();
			tr.removeClass('shown');
		}
		else {
			// Open this row
			row.child( formatWorkflow(row.data()) ).show();
			tr.addClass('shown');
		}
	} );

});
</script>
